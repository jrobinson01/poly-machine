<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../poly-machine/poly-machine.html">

<dom-module id="poly-machine-app">
  <template>
      <style>
        :host([state='error']) {
          background-color: red;
        }
        div {
          margin: 10px;
        }
      </style>
      <template is="dom-if" if="[[isState(state, states.idle)]]">
        <h3>You can search for people!</h3>
        (try "bob", or "steve")
      </template>
      <template is="dom-if" if="[[oneOfState(state, states.idle, states.results, states.emptyResults, states.error)]]">
        <div>
          <form on-submit="submitSearch">
            <input type="text" value="{{searchTerm::input}}"></input>
            <button type="submit" disabled="[[!searchTermIsValid(searchTerm)]]">Search</button>
          </form>
        </div>
      </template>
      <template is="dom-if" if="[[isState(state, states.loading)]]">
        searching...
      </template>
      <template is="dom-if" if="[[isState(state, states.error)]]">
        Barf. Something has gone horribly wrong.
      </template>
      <template is="dom-if" if="[[isState(state, states.emptyResults)]]">
        Sorry, no users found.
      </template>
      <template is="dom-if" if="[[isState(state, states.results)]]">
        <div>
          <ul>
            <template is="dom-repeat" items="[[results]]">
              <li on-click="clickSelectUser">
                [[item.name]]
              </li>
            </template>
          </ul>
        </div>
      </template>
      <template is="dom-if" if="[[isState(state, states.selected)]]">
        <button on-click="goBack">Back</button>
        <div>
          name: [[selectedUser.name]] age: [[selectedUser.age]]
        </div>
      </template>
    </template>

  <script>

    // fake database
    const dataSource = [
      {name:'Bobby', age:'25'},
      {name:'Jimmy', age:'32'},
      {name:'Fred', age:'12'},
      {name:'June', age:'34'},
      {name:'Angus', age:'89'},
      {name:'Bob', age:'44'},
    ];


    const eventNames = {
      LOADED_RESULTS: 'loaded-results',
      NO_RESULTS: 'no-results',
      ERROR: 'error',
      SEARCH: 'search',
      SELECT_PERSON: 'select-person',
      DESELECT: 'deselect',
    };

    const stateNames = {
      IDLE: 'idle',
      LOADING: 'loading',
      RESULTS: 'results',
      EMPTY_RESULTS:'empty-results',
      ERROR: 'error',
      SELECTED: 'selected',
    }


    // this event is duplicated amongst a few states
    const searchEvent = {
      event: eventNames.SEARCH,
      target: stateNames.LOADING,
      cond: function() {
        return this.searchTermIsValid(this.searchTerm);
      }
    };

    /**
     * @customElement
     * @polymer
     */
    class PolyMachineApp extends polyMachineMixin(Polymer.Element) {

      static get is() { return 'poly-machine-app'; }

      static get properties() {
        return {
          states:{
            type: Object,
            value: () => ({
              idle: {
                name: stateNames.IDLE,
                events: [
                  searchEvent
                ]
              },
              loading: {
                name: stateNames.LOADING,
                onEntry:  function() { this.doSearch() },
                events: [
                  {
                    event: eventNames.LOADED_RESULTS,
                    target: stateNames.RESULTS,
                    cond:function() {
                      return this.results.length > 0;
                    }
                  },
                  {
                    event: eventNames.NO_RESULTS,
                    target: stateNames.EMPTY_RESULTS,
                    cond:function() {
                      return this.results.length === 0;
                    }
                  },
                  {
                    event: eventNames.ERROR,
                    target: stateNames.ERROR
                  }
                ]
              },
              results: {
                name: stateNames.RESULTS,
                events: [
                  {
                    event: eventNames.SELECT_PERSON,
                    target: stateNames.SELECTED,
                    cond: function() {
                      return Boolean(this.selectedUser);
                    }
                  },
                  searchEvent
                ]
              },
              emptyResults: {
                name: stateNames.EMPTY_RESULTS,
                events: [
                  searchEvent
                ]
              },
              error: {
                name: stateNames.ERROR,
                events: [
                  searchEvent
                ]
              },
              selected: {
                name: stateNames.SELECTED,
                events: [
                  {
                    event: eventNames.DESELECT,
                    target: stateNames.RESULTS
                  }
                ]
              },
            })
          },
          initialState: {
            type: String,
            value: stateNames.IDLE
          },
          results: {
            type: Object
          },
          searchTerm: {
            type: String,
            value: ''// value required to trigger binding
          },
          selectedUser: {
            type: Object
          }
        }
      }

      submitSearch(event) {
        event.preventDefault();
        this.send(eventNames.SEARCH);
      }

      clickSelectUser(event) {
        this.selectedUser = event.model.item;
        this.send(eventNames.SELECT_PERSON);
      }

      searchTermIsValid(term) {
        return Boolean(term && term.trim().length >= 3);
      }

      doSearch() {
        setTimeout(() => {
          this.results = dataSource.filter(u =>
            u.name.toLowerCase().includes(this.searchTerm.toLowerCase().trim()));
          if(this.searchTerm === 'steve') {
            this.send(eventNames.ERROR);
          } else if (this.results.length === 0) {
            this.send(eventNames.NO_RESULTS);
          } else {
            this.send(eventNames.LOADED_RESULTS);
          }
        }, 1000);
      }

      goBack(event) {
        this.send(eventNames.DESELECT);
      }

    }

    window.customElements.define(PolyMachineApp.is, PolyMachineApp);
  </script>
</dom-module>
